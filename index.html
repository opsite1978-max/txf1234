<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°æŒ‡ç±Œç¢¼çµæ®º - åœ–è¡¨æˆ°æƒ…ç‰ˆ</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; --text: #334155; --red: #ef4444; --green: #22c55e; --input-bg: #f1f5f9; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); margin: 0; padding: 15px; color: var(--text); padding-bottom: 220px; }
        .container { max-width: 600px; margin: 0 auto; background: var(--card); padding: 20px; border-radius: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        
        header { text-align: center; margin-bottom: 20px; }
        h1 { font-size: 22px; margin: 0; color: #0f172a; font-weight: 800; }
        .subtitle { font-size: 13px; color: #64748b; margin-top: 6px; }

        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .action-btn { flex: 1; padding: 12px; font-size: 14px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-auto { background: #3b82f6; color: white; }
        .btn-auto:active { background: #2563eb; transform: scale(0.98); }
        .btn-clear { background: #e2e8f0; color: #475569; max-width: 100px; }
        
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* åœ–è¡¨å€å¡Š */
        #chart-container {
            width: 100%;
            height: 350px;
            margin-bottom: 25px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        .chart-legend {
            position: absolute; left: 10px; top: 10px; z-index: 20; 
            font-size: 11px; font-family: monospace; pointer-events: none;
            background: rgba(255,255,255,0.8); padding: 4px; border-radius: 4px;
        }
        .legend-item { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }

        .section-title { font-size: 13px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; margin: 20px 0 10px 0; display: flex; align-items: center; gap: 8px; }
        .section-title::after { content: ""; flex: 1; height: 1px; background: #e2e8f0; }

        .input-row { display: flex; gap: 12px; margin-bottom: 12px; }
        .input-group { flex: 1; position: relative; }
        label { display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500; }
        
        input { width: 100%; padding: 12px; border: 2px solid transparent; border-radius: 12px; font-size: 16px; font-weight: 600; box-sizing: border-box; background: var(--input-bg); color: #334155; outline: none; transition: 0.2s; -webkit-appearance: none; }
        input:focus { background: #fff; border-color: var(--primary); }

        .tx-input input { border: 2px solid #bfdbfe; background: #eff6ff; color: #1e3a8a; }
        .long-input input { color: var(--red); background: #fef2f2; }
        .long-input input:focus { border-color: var(--red); }
        .short-input input { color: var(--green); background: #f0fdf4; }
        .short-input input:focus { border-color: var(--green); }

        /* çµæœå¡ç‰‡ */
        #result-card { 
            position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); 
            width: 95%; max-width: 580px; 
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px);
            border-radius: 16px; 
            box-shadow: 0 -5px 30px rgba(0,0,0,0.15); 
            border: 1px solid #e2e8f0;
            z-index: 100;
            overflow: hidden;
            transition: 0.3s;
        }
        .result-header { padding: 10px 15px; text-align: center; color: white; font-weight: bold; font-size: 15px; display: flex; justify-content: space-between; align-items: center; }
        .bg-red { background: linear-gradient(135deg, #ef4444, #b91c1c); } 
        .bg-green { background: linear-gradient(135deg, #22c55e, #15803d); } 
        .bg-gray { background: #64748b; }
        .result-content { padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; }
        .main-stat { text-align: left; }
        .stat-value { font-size: 20px; font-weight: 800; font-family: monospace; }
        .target-box { text-align: right; }
        .target-price { font-size: 18px; font-weight: 800; }
        .target-desc { font-size: 12px; opacity: 0.8; }
        #status-msg { text-align: center; font-size: 12px; margin-bottom: 10px; min-height: 18px; font-weight: 500; color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ“‰ å°æŒ‡ç±Œç¢¼çµæ®º <span style="font-size:12px; background:#eff6ff; color:#2563eb; padding:3px 8px; border-radius:20px;">Chartç‰ˆ</span></h1>
        <div class="subtitle">è‡ªå‹•æŠ“å–å¤§ç›¤Kç·š + å‡ç·š/å¸ƒæ—å¸¶</div>
    </header>

    <div class="btn-group">
        <button class="action-btn btn-auto" onclick="autoDetect()" id="autoBtn">
            <span id="btn-icon">ğŸ”„</span> æ›´æ–° K ç·šèˆ‡æ•¸æ“š
        </button>
        <button class="action-btn btn-clear" onclick="clearAll()">ğŸ—‘ï¸ æ¸…é™¤</button>
    </div>
    <div id="status-msg"></div>

    <div id="chart-container">
        <div class="chart-legend" id="chart-legend">
            <div>è¼‰å…¥å¾Œé¡¯ç¤ºæŒ‡æ¨™...</div>
        </div>
    </div>

    <div class="section-title">ğŸ“Š åƒ¹æ ¼åƒæ•¸</div>
    <div class="input-row">
        <div class="input-group">
            <label>åŠ æ¬ŠæŒ‡æ•¸</label>
            <input type="number" id="spot_price" placeholder="è‡ªå‹•" disabled style="background:#f1f5f9;">
        </div>
        <div class="input-group">
            <label>æ³¢å‹•ç‡ (ATR)</label>
            <input type="number" id="volatility" placeholder="300" oninput="saveAndCalc()">
        </div>
    </div>
    
    <div class="input-row">
        <div class="input-group tx-input">
            <label>ğŸ“ å°æŒ‡æœŸ (ç›®æ¨™è¨ˆç®—åŸºæº–)</label>
            <input type="number" id="tx_price" placeholder="è¼¸å…¥æœŸè²¨é»æ•¸" oninput="saveAndCalc()">
        </div>
    </div>

    <div class="section-title">ğŸ“‰ æ•£æˆ¶ç±Œç¢¼ (å°å°/å¾®å°)</div>
    <div class="input-row">
        <div class="input-group long-input">
            <label>MTX å¤šå–®</label>
            <input type="number" id="mtx_long" placeholder="0" oninput="saveAndCalc()">
        </div>
        <div class="input-group short-input">
            <label>MTX ç©ºå–®</label>
            <input type="number" id="mtx_short" placeholder="0" oninput="saveAndCalc()">
        </div>
    </div>
    <div class="input-row">
        <div class="input-group long-input">
            <label>TMF å¤šå–®</label>
            <input type="number" id="tmf_long" placeholder="0" oninput="saveAndCalc()">
        </div>
        <div class="input-group short-input">
            <label>TMF ç©ºå–®</label>
            <input type="number" id="tmf_short" placeholder="0" oninput="saveAndCalc()">
        </div>
    </div>
</div>

<div id="result-card">
    <div id="res-header" class="result-header">
        <span id="header-title">ç­‰å¾…æ•¸æ“š...</span>
        <span style="font-size:11px; background:rgba(255,255,255,0.2); padding:2px 6px; border-radius:4px;">å³æ™‚</span>
    </div>
    <div class="result-content">
        <div class="main-stat">
            <div style="font-size:11px; color:#64748b">æ•£æˆ¶æ·¨å–®</div>
            <div class="stat-value" id="res-total">0</div>
        </div>
        <div class="target-box">
            <div style="font-size:11px; color:#475569" id="target-label">ç›®æ¨™åƒ¹</div>
            <div class="target-price" id="res-price">--</div>
            <div class="target-desc" id="res-action">è§€æœ›</div>
        </div>
    </div>
</div>

<script>
    // --- å…¨å±€è®Šæ•¸ ---
    let chart, candleSeries, ma60Series, ma200Series, bbUpperSeries, bbLowerSeries;
    let targetPriceLine = null; // ç”¨ä¾†å­˜å„²ç›®æ¨™åƒ¹ç·š
    const fields = ['spot_price', 'volatility', 'tx_price', 'mtx_long', 'mtx_short', 'tmf_long', 'tmf_short'];

    // --- åˆå§‹åŒ–åœ–è¡¨ ---
    function initChart() {
        const container = document.getElementById('chart-container');
        chart = LightweightCharts.createChart(container, {
            width: container.clientWidth,
            height: 350,
            layout: { background: { color: '#ffffff' }, textColor: '#333' },
            grid: { vertLines: { color: '#f0f3fa' }, horzLines: { color: '#f0f3fa' } },
            rightPriceScale: { borderColor: '#dfe1e5' },
            timeScale: { borderColor: '#dfe1e5', rightOffset: 5 },
            crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
        });

        candleSeries = chart.addCandlestickSeries({ upColor: '#ef4444', downColor: '#22c55e', borderUpColor: '#ef4444', borderDownColor: '#22c55e', wickUpColor: '#ef4444', wickDownColor: '#22c55e' });
        
        // è¨­å®šç·šæ¢æ¨£å¼
        ma60Series = chart.addLineSeries({ color: '#2563eb', lineWidth: 2, title: 'MA60' }); // è—è‰²å­£ç·š
        ma200Series = chart.addLineSeries({ color: '#d97706', lineWidth: 2, title: 'MA200' }); // æ©˜è‰²å¹´ç·š
        bbUpperSeries = chart.addLineSeries({ color: '#9333ea', lineWidth: 1, lineStyle: 2, title: 'BB Upper' }); // ç´«è‰²å¸ƒæ—ä¸Š
        bbLowerSeries = chart.addLineSeries({ color: '#9333ea', lineWidth: 1, lineStyle: 2, title: 'BB Lower' }); // ç´«è‰²å¸ƒæ—ä¸‹

        // RWD è‡ªé©æ‡‰
        window.addEventListener('resize', () => {
            chart.applyOptions({ width: container.clientWidth });
        });
    }

    window.onload = function() {
        initChart();
        fields.forEach(id => {
            const savedVal = localStorage.getItem(id);
            if (savedVal) document.getElementById(id).value = savedVal;
        });
        // å˜—è©¦å¾ localStorage æ¢å¾©åœ–è¡¨æ•¸æ“šæ˜¯æ¯”è¼ƒå›°é›£çš„ï¼Œé€™è£¡æˆ‘å€‘åªæ¢å¾©è¼¸å…¥æ¡†ï¼Œ
        // ä½¿ç”¨è€…éœ€è¦æŒ‰ã€Œæ›´æ–°ã€ä¾†ç•«åœ–ã€‚
        calculate();
    }

    // --- æŠ€è¡“æŒ‡æ¨™è¨ˆç®—å‡½æ•¸ ---
    function calculateSMA(data, period) {
        let result = [];
        for (let i = 0; i < data.length; i++) {
            if (i < period - 1) { result.push({ time: data[i].time, value: NaN }); continue; }
            let sum = 0;
            for (let j = 0; j < period; j++) sum += data[i - j].close;
            result.push({ time: data[i].time, value: sum / period });
        }
        return result.filter(d => !isNaN(d.value));
    }

    function calculateBollinger(data, period, stdDevMultiplier) {
        let upper = [], lower = [];
        for (let i = 0; i < data.length; i++) {
            if (i < period - 1) { 
                upper.push({ time: data[i].time, value: NaN });
                lower.push({ time: data[i].time, value: NaN });
                continue; 
            }
            // è¨ˆç®— SMA
            let sum = 0;
            for (let j = 0; j < period; j++) sum += data[i - j].close;
            let sma = sum / period;

            // è¨ˆç®—æ¨™æº–å·®
            let sumSqDiff = 0;
            for (let j = 0; j < period; j++) {
                sumSqDiff += Math.pow(data[i - j].close - sma, 2);
            }
            let stdDev = Math.sqrt(sumSqDiff / period);

            upper.push({ time: data[i].time, value: sma + stdDev * stdDevMultiplier });
            lower.push({ time: data[i].time, value: sma - stdDev * stdDevMultiplier });
        }
        return { upper: upper.filter(d => !isNaN(d.value)), lower: lower.filter(d => !isNaN(d.value)) };
    }

    // --- è³‡æ–™æŠ“å–èˆ‡è™•ç† ---
    async function autoDetect() {
        const btn = document.getElementById('autoBtn');
        const icon = document.getElementById('btn-icon');
        const status = document.getElementById('status-msg');
        
        btn.disabled = true;
        icon.classList.add('loading-spin');
        status.innerText = "æ­£åœ¨ä¸‹è¼‰è¿‘ä¸€å¹´ K ç·šè³‡æ–™...";
        status.style.color = "var(--primary)";

        try {
            // æŠ“å– 1 å¹´ä»½çš„è³‡æ–™ (range=1y) ä»¥è¨ˆç®— MA200
            const symbol = "%5ETWII"; 
            const timestamp = new Date().getTime();
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent('https://query1.finance.yahoo.com/v8/finance/chart/' + symbol + '?interval=1d&range=1y&events=history&_=' + timestamp)}`;
            
            const response = await fetch(proxyUrl);
            if (!response.ok) throw new Error("API Error");
            const data = await response.json();
            const yahooData = JSON.parse(data.contents);
            if (!yahooData.chart || !yahooData.chart.result) throw new Error("No Data");
            
            const result = yahooData.chart.result[0];
            const quotes = result.indicators.quote[0];
            const timestamps = result.timestamp;

            // æ•´ç†æˆ Lightweight Charts æ ¼å¼
            let ohlcData = [];
            let validHighs = [], validLows = []; // ç”¨ä¾†ç®— ATR

            for (let i = 0; i < timestamps.length; i++) {
                if (quotes.open[i] && quotes.high[i] && quotes.low[i] && quotes.close[i]) {
                    // è½‰æ›æ™‚é–“æˆ³ç‚º YYYY-MM-DD
                    let date = new Date(timestamps[i] * 1000);
                    let timeStr = date.toISOString().split('T')[0];
                    
                    ohlcData.push({
                        time: timeStr,
                        open: quotes.open[i],
                        high: quotes.high[i],
                        low: quotes.low[i],
                        close: quotes.close[i]
                    });
                    validHighs.push(quotes.high[i]);
                    validLows.push(quotes.low[i]);
                }
            }

            // æ›´æ–°åœ–è¡¨æ•¸æ“š
            candleSeries.setData(ohlcData);

            // è¨ˆç®—æŒ‡æ¨™
            const ma60Data = calculateSMA(ohlcData, 60);
            const ma200Data = calculateSMA(ohlcData, 200);
            const bbData = calculateBollinger(ohlcData, 20, 2); // å¸ƒæ—å¸¶é€šå¸¸ç”¨ 20MA, 2å€æ¨™æº–å·®

            ma60Series.setData(ma60Data);
            ma200Series.setData(ma200Data);
            bbUpperSeries.setData(bbData.upper);
            bbLowerSeries.setData(bbData.lower);

            // æ›´æ–°åœ–ä¾‹æ–‡å­—
            const lastC = ohlcData[ohlcData.length-1];
            document.getElementById('chart-legend').innerHTML = `
                <div class="legend-item"><b>åŠ æ¬ŠæŒ‡æ•¸</b>: ${Math.round(lastC.close)}</div>
                <div class="legend-item"><span class="dot" style="background:#2563eb"></span>MA60: ${Math.round(ma60Data[ma60Data.length-1].value)}</div>
                <div class="legend-item"><span class="dot" style="background:#d97706"></span>MA200: ${Math.round(ma200Data[ma200Data.length-1].value)}</div>
                <div class="legend-item"><span class="dot" style="background:#9333ea"></span>BB: ${Math.round(bbData.upper[bbData.upper.length-1].value)} / ${Math.round(bbData.lower[bbData.lower.length-1].value)}</div>
            `;

            // è¨ˆç®— ATR (å–æœ€å¾Œ 5 å¤©)
            let totalRange = 0, count = 0;
            for (let i = validHighs.length - 5; i < validHighs.length; i++) {
                if (i >= 0) {
                    totalRange += (validHighs[i] - validLows[i]);
                    count++;
                }
            }
            const avgVol = count > 0 ? Math.round(totalRange / count) : 300;
            const lastClosePrice = Math.round(ohlcData[ohlcData.length-1].close);

            // å¡«å…¥ UI
            document.getElementById('spot_price').value = lastClosePrice;
            document.getElementById('volatility').value = avgVol;
            
            // å¦‚æœå°æŒ‡æœŸæ˜¯ç©ºçš„ï¼Œé è¨­å¡«å…¥å¤§ç›¤
            if(!document.getElementById('tx_price').value) {
                document.getElementById('tx_price').value = lastClosePrice;
            }

            saveAndCalc(); // è§¸ç™¼è¨ˆç®—èˆ‡ç•«ç·š
            
            status.innerText = `âœ… Kç·šåœ–èˆ‡æŒ‡æ¨™æ›´æ–°å®Œæˆï¼`;
            status.style.color = "#16a34a";
            
        } catch (error) {
            console.error(error);
            status.innerText = "âš ï¸ è³‡æ–™æŠ“å–å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦";
            status.style.color = "#ef4444";
        } finally {
            btn.disabled = false;
            icon.classList.remove('loading-spin');
        }
    }

    function saveAndCalc() {
        fields.forEach(id => {
            const el = document.getElementById(id);
            if(el) localStorage.setItem(id, el.value);
        });
        calculate();
    }

    function clearAll() {
        if(confirm('æ¸…é™¤æ‰€æœ‰æ•¸æ“šï¼Ÿ')) {
            fields.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
                localStorage.removeItem(id);
            });
            calculate();
        }
    }

    function calculate() {
        let spot = parseInt(document.getElementById('spot_price').value) || 0;
        let tx = parseInt(document.getElementById('tx_price').value);
        let vol = parseInt(document.getElementById('volatility').value) || 300;
        let calcPrice = tx ? tx : spot;
        
        let mtx_L = parseInt(document.getElementById('mtx_long').value) || 0;
        let mtx_S = parseInt(document.getElementById('mtx_short').value) || 0;
        let tmf_L = parseInt(document.getElementById('tmf_long').value) || 0;
        let tmf_S = parseInt(document.getElementById('tmf_short').value) || 0;
        
        let mtx_net = mtx_L - mtx_S;
        let tmf_net_eq = (tmf_L - tmf_S) * 0.2; 
        let total_net = mtx_net + tmf_net_eq;
        let capital = (Math.abs(total_net) * 46000) / 100000000;
        
        const totalEl = document.getElementById('res-total');
        totalEl.innerText = total_net.toLocaleString('en-US', {maximumFractionDigits: 1});
        
        if (total_net > 0) totalEl.style.color = '#ef4444'; 
        else if (total_net < 0) totalEl.style.color = '#22c55e'; 
        else totalEl.style.color = '#334155';
        
        document.getElementById('res-money').innerText = capital.toFixed(2) + " å„„";
        
        let cardHeader = document.getElementById('res-header');
        let headerTitle = document.getElementById('header-title');
        let resPrice = document.getElementById('res-price');
        let resAction = document.getElementById('res-action');
        const THRESHOLD = 1500;
        
        // --- ç•«ç·šé‚è¼¯ ---
        // å…ˆç§»é™¤èˆŠçš„ç·š
        if (targetPriceLine) {
            candleSeries.removePriceLine(targetPriceLine);
            targetPriceLine = null;
        }

        let target = 0;
        let lineColor = '';
        let lineTitle = '';

        if (total_net > THRESHOLD) {
            // æ•£æˆ¶åšå¤š -> ä¸»åŠ›æ®ºç›¤
            cardHeader.className = "result-header bg-green"; 
            headerTitle.innerText = "ğŸ“‰ æ•£æˆ¶åšå¤š âœ ä¸»åŠ›æ®ºç›¤";
            target = calcPrice - vol;
            resPrice.innerText = target;
            resPrice.style.color = "#16a34a"; 
            resAction.innerText = `æ®º ${vol} é»é€¼åœæ`;
            resAction.style.color = "#dcfce7";
            
            lineColor = '#22c55e'; // ç¶ ç·š
            lineTitle = 'ä¸»åŠ›ç›®æ¨™ (æ®º)';

        } else if (total_net < -THRESHOLD) {
            // æ•£æˆ¶åšç©º -> ä¸»åŠ›è»‹ç©º
            cardHeader.className = "result-header bg-red"; 
            headerTitle.innerText = "ğŸ“ˆ æ•£æˆ¶åšç©º âœ ä¸»åŠ›è»‹ç©º";
            target = calcPrice + vol;
            resPrice.innerText = target;
            resPrice.style.color = "#fee2e2"; 
            resAction.innerText = `æ‹‰ ${vol} é»é€¼åœæ`;
            resAction.style.color = "#fee2e2";

            lineColor = '#ef4444'; // ç´…ç·š
            lineTitle = 'ä¸»åŠ›ç›®æ¨™ (è»‹)';

        } else {
            cardHeader.className = "result-header bg-gray";
            headerTitle.innerText = "âš–ï¸ å€é–“éœ‡ç›ª";
            resPrice.innerText = "è§€æœ›";
            resPrice.style.color = "white";
            resAction.innerText = "ç„¡çµæ®ºç›®æ¨™";
            resAction.style.color = "#e2e8f0";
        }

        // å¦‚æœæœ‰ç›®æ¨™åƒ¹ï¼Œä¸”åœ–è¡¨å·²åˆå§‹åŒ–ï¼Œå‰‡åœ¨åœ–è¡¨ä¸Šç•«ç·š
        if (target !== 0 && candleSeries) {
            targetPriceLine = candleSeries.createPriceLine({
                price: target,
                color: lineColor,
                lineWidth: 2,
                lineStyle: 1, // 0:Solid, 1:Dotted, 2:Dashed
                axisLabelVisible: true,
                title: lineTitle,
            });
            // è‡ªå‹•ç¸®æ”¾è®“ç›®æ¨™åƒ¹å¯è¦‹
            chart.timeScale().fitContent();
        }
    }
</script>
</body>
</html>
