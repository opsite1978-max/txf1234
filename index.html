<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°æŒ‡ç±Œç¢¼çµæ®º - å°ˆæ¥­å¢å¼·ç‰ˆ</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; --text: #334155; --red: #ef4444; --green: #22c55e; --input-bg: #f1f5f9; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); margin: 0; padding: 15px; color: var(--text); padding-bottom: 200px; }
        .container { max-width: 480px; margin: 0 auto; background: var(--card); padding: 24px; border-radius: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        header { text-align: center; margin-bottom: 24px; }
        h1 { font-size: 22px; margin: 0; color: #0f172a; font-weight: 800; letter-spacing: -0.5px; }
        .subtitle { font-size: 13px; color: #64748b; margin-top: 6px; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .action-btn { flex: 1; padding: 12px; font-size: 14px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-auto { background: #3b82f6; color: white; }
        .btn-auto:active { background: #2563eb; transform: scale(0.98); }
        .btn-clear { background: #e2e8f0; color: #475569; max-width: 100px; }
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .section-title { font-size: 13px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; margin: 20px 0 10px 0; display: flex; align-items: center; gap: 8px; }
        .section-title::after { content: ""; flex: 1; height: 1px; background: #e2e8f0; }
        .input-row { display: flex; gap: 12px; margin-bottom: 12px; }
        .input-group { flex: 1; position: relative; }
        label { display: block; font-size: 12px; color: #64748b; margin-bottom: 6px; font-weight: 500; }
        input { width: 100%; padding: 14px; border: 2px solid transparent; border-radius: 14px; font-size: 18px; font-weight: 600; box-sizing: border-box; background: var(--input-bg); color: #334155; outline: none; transition: 0.2s; -webkit-appearance: none; }
        input:focus { background: #fff; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }
        input::placeholder { color: #cbd5e1; font-weight: 400; font-size: 16px; }
        
        /* é‡å°å°æŒ‡æœŸæ¬„ä½çš„ç‰¹åˆ¥æ¨£å¼ */
        .tx-input input { border: 2px solid #bfdbfe; background: #eff6ff; color: #1e3a8a; font-weight: 800; }
        .tx-input input:focus { border-color: #2563eb; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.2); }

        .long-input input { color: var(--red); background: #fef2f2; }
        .long-input input:focus { border-color: var(--red); box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1); }
        .short-input input { color: var(--green); background: #f0fdf4; }
        .short-input input:focus { border-color: var(--green); box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1); }
        
        #result-card { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
            width: 90%; max-width: 440px; 
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 20px; 
            box-shadow: 0 -10px 40px rgba(0,0,0,0.15); 
            border: 1px solid rgba(255,255,255,0.5);
            z-index: 100;
            overflow: hidden;
            transition: 0.3s;
        }
        .result-header { padding: 12px; text-align: center; color: white; font-weight: bold; font-size: 16px; display: flex; justify-content: space-between; align-items: center; }
        .bg-red { background: linear-gradient(135deg, #ef4444, #b91c1c); } 
        .bg-green { background: linear-gradient(135deg, #22c55e, #15803d); } 
        .bg-gray { background: #64748b; }
        .result-content { padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; }
        .main-stat { text-align: left; }
        .stat-label { font-size: 12px; color: #64748b; margin-bottom: 2px; }
        .stat-value { font-size: 24px; font-weight: 800; font-family: monospace; letter-spacing: -1px; }
        .target-box { text-align: right; }
        .target-price { font-size: 20px; font-weight: 800; }
        .target-desc { font-size: 12px; opacity: 0.8; }
        #status-msg { text-align: center; font-size: 12px; color: var(--primary); margin-bottom: 10px; min-height: 18px; font-weight: 500; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>ğŸ“‰ å°æŒ‡ç±Œç¢¼çµæ®º <span style="font-size:12px; vertical-align: middle; background:#eff6ff; color:#2563eb; padding:3px 8px; border-radius:20px;">Pro</span></h1>
        <div class="subtitle">æ•£æˆ¶å¤šç©ºç±Œç¢¼è‡ªå‹•è¿½è¹¤ç³»çµ±</div>
    </header>
    <div class="btn-group">
        <button class="action-btn btn-auto" onclick="autoDetect()" id="autoBtn">
            <span id="btn-icon">ğŸ”„</span> æ›´æ–°å¤§ç›¤æ•¸æ“š
        </button>
        <button class="action-btn btn-clear" onclick="clearAll()">
            ğŸ—‘ï¸ æ¸…é™¤
        </button>
    </div>
    <div id="status-msg"></div>

    <div class="section-title">ğŸ“Š åƒ¹æ ¼èˆ‡æ³¢å‹•</div>
    <div class="input-row">
        <div class="input-group">
            <label>åŠ æ¬ŠæŒ‡æ•¸ (åƒè€ƒ)</label>
            <input type="number" id="spot_price" placeholder="è‡ªå‹•æŠ“å–" disabled style="background:#f1f5f9; color:#94a3b8;">
        </div>
        <div class="input-group">
            <label>æ³¢å‹•ç‡ (ATR)</label>
            <input type="number" id="volatility" placeholder="300" oninput="saveAndCalc()">
        </div>
    </div>
    
    <div class="input-row">
        <div class="input-group tx-input">
            <label>ğŸ“ å°æŒ‡æœŸæŒ‡æ•¸ (è¨ˆç®—åŸºæº–)</label>
            <input type="number" id="tx_price" placeholder="è¼¸å…¥ç›®å‰æœŸè²¨é»æ•¸" oninput="saveAndCalc()">
        </div>
    </div>

    <div class="section-title">ğŸ“‰ å°å°æŒ‡ (MTX) æ•£æˆ¶</div>
    <div class="input-row">
        <div class="input-group long-input">
            <label>å¤šå–® (Long)</label>
            <input type="number" id="mtx_long" placeholder="0" oninput="saveAndCalc()">
        </div>
        <div class="input-group short-input">
            <label>ç©ºå–® (Short)</label>
            <input type="number" id="mtx_short" placeholder="0" oninput="saveAndCalc()">
        </div>
    </div>
    <div class="section-title">ğŸ“‰ å¾®å°æŒ‡ (TMF) æ•£æˆ¶</div>
    <div class="input-row">
        <div class="input-group long-input">
            <label>å¤šå–® (Long)</label>
            <input type="number" id="tmf_long" placeholder="0" oninput="saveAndCalc()">
        </div>
        <div class="input-group short-input">
            <label>ç©ºå–® (Short)</label>
            <input type="number" id="tmf_short" placeholder="0" oninput="saveAndCalc()">
        </div>
    </div>
</div>

<div id="result-card">
    <div id="res-header" class="result-header">
        <span id="header-title">ç­‰å¾…æ•¸æ“š...</span>
        <span style="font-size:11px; background:rgba(255,255,255,0.2); padding:2px 6px; border-radius:4px;">å³æ™‚é‹ç®—</span>
    </div>
    <div class="result-content">
        <div class="main-stat">
            <div class="stat-label">æ•£æˆ¶ç¸½æ¬Šé‡æ·¨å–®</div>
            <div class="stat-value" id="res-total">0</div>
            <div class="stat-label" style="margin-top:4px;">é ä¼°è³‡é‡‘: <span id="res-money">0</span> å„„</div>
        </div>
        <div class="target-box">
            <div class="stat-label" id="target-label">ä¸»åŠ›ç›®æ¨™ (æœŸ)</div>
            <div class="target-price" id="res-price">--</div>
            <div class="target-desc" id="res-action">è§€æœ›ä¸­</div>
        </div>
    </div>
</div>

<script>
    // æ¬„ä½åˆ—è¡¨ï¼Œæ–°å¢ tx_price
    const fields = ['spot_price', 'volatility', 'tx_price', 'mtx_long', 'mtx_short', 'tmf_long', 'tmf_short'];

    window.onload = function() {
        fields.forEach(id => {
            const savedVal = localStorage.getItem(id);
            if (savedVal) document.getElementById(id).value = savedVal;
        });
        calculate();
    }
    
    function saveAndCalc() {
        fields.forEach(id => {
            const el = document.getElementById(id);
            // spot_price æ˜¯ disabled çš„ï¼Œä¹Ÿè¦å­˜ä¸€ä¸‹æ–¹ä¾¿ä¸‹æ¬¡çœ‹
            if(el) localStorage.setItem(id, el.value);
        });
        calculate();
    }
    
    function clearAll() {
        if(confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è¼¸å…¥çš„æ•¸æ“šå—ï¼Ÿ')) {
            fields.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
                localStorage.removeItem(id);
            });
            calculate();
            document.getElementById('status-msg').innerText = "å·²æ¸…é™¤æ•¸æ“š";
        }
    }
    
    async function autoDetect() {
        const btn = document.getElementById('autoBtn');
        const icon = document.getElementById('btn-icon');
        const status = document.getElementById('status-msg');
        
        const spotInput = document.getElementById('spot_price');
        const txInput = document.getElementById('tx_price');
        const volInput = document.getElementById('volatility');
        
        btn.disabled = true;
        icon.classList.add('loading-spin');
        btn.style.opacity = "0.7";
        status.innerText = "æ­£åœ¨é€£ç·š Yahoo Finance...";
        status.style.color = "var(--primary)";
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 8000);
        
        try {
            const symbol = "%5ETWII"; 
            const timestamp = new Date().getTime();
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent('https://query1.finance.yahoo.com/v8/finance/chart/' + symbol + '?interval=1d&range=10d&_=' + timestamp)}`;
            
            const response = await fetch(proxyUrl, { signal: controller.signal });
            clearTimeout(timeoutId);
            
            if (!response.ok) throw new Error("ç¶²è·¯å›æ‡‰éŒ¯èª¤");
            const data = await response.json();
            const yahooData = JSON.parse(data.contents);
            if (!yahooData.chart || !yahooData.chart.result) throw new Error("ç„¡æ•¸æ“šå…§å®¹");
            
            const result = yahooData.chart.result[0];
            const quotes = result.indicators.quote[0];
            const lastClose = result.meta.regularMarketPrice;
            
            let totalRange = 0;
            let count = 0;
            const len = quotes.high.length;
            const daysToCalc = 5;
            for (let i = len - daysToCalc; i < len; i++) {
                if (quotes.high[i] && quotes.low[i]) {
                    totalRange += (quotes.high[i] - quotes.low[i]);
                    count++;
                }
            }
            const avgVol = count > 0 ? Math.round(totalRange / count) : 300;
            
            // å¡«å…¥æ•¸å€¼
            spotInput.value = Math.round(lastClose); // å¡«å…¥åŠ æ¬ŠæŒ‡æ•¸(åƒè€ƒç”¨)
            volInput.value = avgVol;                 // å¡«å…¥æ³¢å‹•
            
            // å¦‚æœå°æŒ‡æœŸæ¬„ä½æ˜¯ç©ºçš„ï¼Œæˆ–ä½¿ç”¨è€…æƒ³é‡æ–°æŠ“ï¼Œæˆ‘å€‘è‡ªå‹•æŠŠå°æŒ‡æœŸé è¨­ç‚ºå¤§ç›¤æŒ‡æ•¸
            // è®“ä½¿ç”¨è€…è‡ªå·±å»å¾®èª¿åƒ¹å·®ï¼Œé€™æ¨£æ¯”è¼ƒæ–¹ä¾¿
            txInput.value = Math.round(lastClose); 
            
            saveAndCalc();
            status.innerText = `âœ… æ›´æ–°æˆåŠŸï¼å¤§ç›¤ ${Math.round(lastClose)} | æ³¢å‹• ${avgVol}`;
            status.style.color = "#16a34a";
            
        } catch (error) {
            console.error(error);
            status.innerText = "âš ï¸ é€£ç·šé€¾æ™‚ï¼Œè«‹æ‰‹å‹•è¼¸å…¥ã€‚";
            status.style.color = "#ef4444";
        } finally {
            btn.disabled = false;
            icon.classList.remove('loading-spin');
            btn.style.opacity = "1";
        }
    }
    
    function calculate() {
        // å–å¾—åƒ¹æ ¼ï¼šå„ªå…ˆä½¿ç”¨å°æŒ‡æœŸ(tx)ï¼Œå¦‚æœæ²’å¡«å°±ç”¨åŠ æ¬Š(spot)
        let spot = parseInt(document.getElementById('spot_price').value) || 0;
        let tx = parseInt(document.getElementById('tx_price').value);
        let vol = parseInt(document.getElementById('volatility').value) || 300;
        
        // å¦‚æœå°æŒ‡æœŸæ²’å¡«ï¼Œå°±æš«æ™‚ç”¨åŠ æ¬ŠæŒ‡æ•¸ä¾†ç®—
        let calcPrice = tx ? tx : spot;
        
        let mtx_L = parseInt(document.getElementById('mtx_long').value) || 0;
        let mtx_S = parseInt(document.getElementById('mtx_short').value) || 0;
        let tmf_L = parseInt(document.getElementById('tmf_long').value) || 0;
        let tmf_S = parseInt(document.getElementById('tmf_short').value) || 0;
        
        let mtx_net = mtx_L - mtx_S;
        let tmf_net_eq = (tmf_L - tmf_S) * 0.2; 
        let total_net = mtx_net + tmf_net_eq;
        let capital = (Math.abs(total_net) * 46000) / 100000000;
        
        const totalEl = document.getElementById('res-total');
        totalEl.innerText = total_net.toLocaleString('en-US', {maximumFractionDigits: 1});
        
        if (total_net > 0) totalEl.style.color = '#ef4444'; 
        else if (total_net < 0) totalEl.style.color = '#22c55e'; 
        else totalEl.style.color = '#334155';
        
        document.getElementById('res-money').innerText = capital.toFixed(2);
        
        let cardHeader = document.getElementById('res-header');
        let headerTitle = document.getElementById('header-title');
        let resPrice = document.getElementById('res-price');
        let resAction = document.getElementById('res-action');
        const THRESHOLD = 1500;
        
        if (total_net > THRESHOLD) {
            cardHeader.className = "result-header bg-green"; 
            headerTitle.innerText = "ğŸ“‰ æ•£æˆ¶åšå¤š âœ ä¸»åŠ›æ®ºç›¤";
            let target = calcPrice - vol;
            resPrice.innerText = target;
            resPrice.style.color = "#16a34a"; 
            resAction.innerText = `æ®º ${vol} é» (${target}) é€¼åœæ`;
            resAction.style.color = "#dcfce7";
        } else if (total_net < -THRESHOLD) {
            cardHeader.className = "result-header bg-red"; 
            headerTitle.innerText = "ğŸ“ˆ æ•£æˆ¶åšç©º âœ ä¸»åŠ›è»‹ç©º";
            let target = calcPrice + vol;
            resPrice.innerText = target;
            resPrice.style.color = "#fee2e2"; 
            resAction.innerText = `æ‹‰ ${vol} é» (${target}) é€¼åœæ`;
            resAction.style.color = "#fee2e2";
        } else {
            cardHeader.className = "result-header bg-gray";
            headerTitle.innerText = "âš–ï¸ ç±Œç¢¼å¹³è¡¡ âœ å€é–“éœ‡ç›ª";
            resPrice.innerText = "è§€æœ›";
            resPrice.style.color = "white";
            resAction.innerText = "ç„¡æ˜é¡¯çµæ®ºç›®æ¨™";
            resAction.style.color = "#e2e8f0";
        }
    }
</script>
</body>
</html>
